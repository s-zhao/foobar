"""filters     - readables        - field filter    - writables        - field fiter    - deletables    - can-create"""import decimal, uuid, datetimefrom django.db import modelsfrom django.db.models import F, Qfrom django.db.models.query import QuerySetfrom foobar.models import test## queryset provided custom query filters#class PortalQuerySet(QuerySet):    def readables(self):        """        public - allow current year        logged in user - allow DODGE any years        """        filter = Q(date__year=2013)                loggedin = True        if loggedin:            filter = filter | Q(car__model__maker__name='DODGE')        return self.filter(filter)                #    # queryset db write related methods    # ===============================================================================================    #    # from db.models.manager.py -    #    #   manager.'bulk_create', 'create', 'get_or_create', 'select_for_update', 'update'    #    # all dispatched to:    #    #   queryset.***    #    # queryset. - 'create', 'delete', '', 'update'    #    def create(self, *args, **kwargs):        """call instance init and save methods                so logic should go to model instance                per django doc, this is shorthand for            o = model(kwargs)            o.save()        """        print '@PortalQuerySet.create'        return super(PortalQuerySet, self).create(*args, **kwargs)    #    # batch operations    #            def update(self, *args, **kwargs):        """bypass instance's save method. so logic should go here ...                   apply update permission filter or pull records, update one by one        """        print '@PortalQuerySet.update, count: ', self.count()        #self.updatables()        return super(PortalQuerySet, self).update(*args, **kwargs)            def delete(self, *args, **kwargs):        """bypass instance's delete method, so logic should go here ...                   apply delete permission filter or pull records, delete one by one        """        print '@PortalQuerySet.delete, count: ', self.count()        return super(PortalQuerySet, self).delete(*args, **kwargs)        #    # disable them    #    def get_or_create(self, *args, **kwargs):        print '@PortalQuerySet.get_or_create'        raise "NotSupported"        def bulk_create(self, *args, **kwargs):        print '@PortalQuerySet.bulk_create'        raise "NotSupported"            def select_for_update(self, *args, **kwargs):        print '@PortalQuerySet.select_for_update'        raise "NotSupported"    class PortalRegistrationManager(models.Manager):    def get_query_set(self):        queryset = PortalQuerySet(self.model)        #        #queryset.filter(can-access)        #        return queryset        class Registration(test.models.Registration):    class Meta:        proxy = True        objects = PortalRegistrationManager().readables()             #    # instance methods    #    def __init__(self, *args, **kwargs):        super(Registration, self).__init__(*args, **kwargs)        if self.id:            print '@proxy.__init__ - pulling record - RECORD READ ACCESS RULES ...'            self.vin = None        else:            print '@proxy.__init__ - creating record'        #        # logic to filter out fields        # take out VIN #        #        def z_list(self):        return self.objects.all().readables()            def save(self, *args, **kwargs):        if self.id:            print '@proxy.save - RECORD UPDATE RULES ..'            # logic to filter out non-updatable fields        else:            # CREATE Permission            print '@proxy.save - RECORD CREATION RULES ..'                return super(Registration, self).save(*args, **kwargs)            def delete(self, *args, **kwargs):        print '@proxy.delete - RECORD DELETION RULES ...'        # DELETE premission        return super(Registration, self).delete(*args, **kwargs)            def __unicode__(self):        return u'%s: %s %s' % (self.__class__, self.car.year, self.car.model.name)            #    # restful: INSERT, UPDATE, DELETE, GET, LIST    #    #    def test_instance_methods():    """    dodge_model = test.models.Maker.objects.get(name='DODGE').mdl_set.all()[0]    dodge_car = dodge_model.car_set.filter(year__gt=2000)[0]    dodge_registration = dodge_car.registration_set.all()[0]    """        dodge_registrations = Registration.objects.filter(car__model__maker__name='DODGE')[:5]    print    print dodge_registrations    print        dodge_registration = Registration.objects.filter(car__model__maker__name='DODGE')[0]        fields = ['date', 'state', 'zip', 'reg_type_car', 'car', 'price','notes']    d = { f:getattr(dodge_registration, f) for f in fields}        d['vin'] = uuid.uuid4().hex.upper()        new_registration = Registration(**d)    new_registration.save()    id = new_registration.id    print    print new_registration    print        new_registration.notes = "record update"    new_registration.save()        print    new_registration.delete()        assert Registration.objects.filter(id=id).exists() == False    def test_queryset():    qset = Registration.objects.filter(car__model__maker__name='DODGE')        dodge_registration = qset[0]    fields = ['date', 'state', 'zip', 'car', 'price','notes']    d = { f:getattr(dodge_registration, f) for f in fields}    d['reg_type_car'] = test.models.Registration.OTHER        for i in range(3):        print        print '... creating record ..............'        d['vin'] = uuid.uuid4().hex.upper()        Registration.objects.create(**d)        qset = Registration.objects.filter(car__model__maker__name='DODGE', reg_type_car=test.models.Registration.OTHER)    print    print '.... update .... '    qset.update(price=F('price')*decimal.Decimal('0.95'))        print    print '.... delete ...'    qset.delete()    def run():    qset = Registration.objects.filter(car__model__maker__name='HONDA') #, date__lt=datetime.date(2013, 1, 1))    print    print qset.query    print 'HONDA count: ', qset.count()    for r in qset.all()[:5]:        print r.id, r.car, r.vin            print    rd = Registration.objects.get(id=4530)    print rd.car, rd.vin    